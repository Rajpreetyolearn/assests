# Centralized S3 Media Upload Service: Technical Documentation

## 1. Overview

This document provides a detailed technical overview of the Centralized S3 Media Upload Service. This microservice, built with FastAPI, is designed to be a robust, centralized solution for generating, processing, and uploading various media types to an AWS S3 bucket.

Its primary purpose is to offload complex media handling from other applications (like AI agents), providing simple HTTP endpoints to perform tasks like rendering diagrams or code into images and storing them in the cloud.

---

## 2. Core Features

The service exposes a set of powerful features through a simple REST API:

*   **Source Code to Image Rendering**: Converts blocks of source code (e.g., Python, JavaScript) into syntax-highlighted PNG images using `Pygments` and `Playwright`.
*   **Mermaid Diagram Rendering**: Renders `Mermaid.js` syntax into PNG diagrams, perfect for visualizing flowcharts, sequences, or gantt charts generated by an AI.
*   **Base64 Image Upload**: Accepts a Base64-encoded string and uploads it as an image file to S3.
*   **Remote Audio Upload**: Downloads an audio file from a given URL and uploads it to S3, ideal for handling audio generated by third-party Text-to-Speech (TTS) services.
*   **Direct File Upload**: Supports standard multipart/form-data uploads for images and other generic files.
*   **Centralized Configuration**: Uses environment variables for easy configuration of AWS credentials and S3 bucket details.

---

## 3. Architecture & Core Components

The service is built on a modern Python stack, leveraging powerful libraries to handle web requests, cloud integration, and browser automation.

### 3.1. FastAPI (Web Framework)

*   **Role**: Serves as the backbone of the application, handling incoming HTTP requests, routing, data validation, and response generation.
*   **Why it's used**: FastAPI's high performance and automatic data validation with Pydantic models ensure that API interactions are fast and type-safe. It also automatically generates interactive API documentation (via OpenAPI), which is crucial for service discovery and testing.

### 3.2. Boto3 (AWS SDK for Python)

*   **Role**: Manages all interactions with AWS S3.
*   **Mechanism**: It handles the authentication (automatically picking up credentials from environment variables) and the file stream upload process. The `upload_fileobj` method is used for efficient streaming of in-memory files (like rendered images) directly to S3 without writing them to disk first.

### 3.3. Playwright (Browser Automation)

*   **Role**: The core engine for rendering web content into images.
*   **Mechanism**:
    *   For **Mermaid diagrams**, Playwright launches a headless Chromium browser, loads an HTML page containing the Mermaid.js library and the user's code, waits for the SVG to be rendered, and then takes a screenshot of the resulting diagram element.
    *   For **source code**, a similar process is used. The code is first converted to syntax-highlighted HTML, which is then loaded and screenshotted by Playwright.
*   **Why it's used**: Playwright provides a reliable way to render complex JavaScript-dependent content exactly as it would appear in a browser, ensuring high-fidelity image output.

### 3.4. Pygments (Syntax Highlighting)

*   **Role**: Used to convert raw source code into styled HTML for rendering.
*   **Mechanism**: It takes a string of code and a language identifier (e.g., "python") and produces an HTML document with `<span>` tags and CSS classes corresponding to the syntax tokens. This HTML is then fed to Playwright.

---

## 4. Setup and Configuration

To run the service, you must configure the following environment variables. This is typically done in a `.env` file.

```dotenv
# .env

# AWS Configuration
AWS_ACCESS_KEY_ID="YOUR_AWS_ACCESS_KEY"
AWS_SECRET_ACCESS_KEY="YOUR_AWS_SECRET_KEY"
AWS_BUCKET_NAME="your-s3-bucket-name"
AWS_REGION="your-aws-region" # e.g., us-west-2
```

### Dependencies

All required Python packages are listed in `requirements.txt`. Install them using:
```bash
pip install -r requirements.txt
```

Additionally, the service requires Playwright's browser binaries to be installed. Run this command once after installing the pip packages:
```bash
playwright install --with-deps
```

### Running the Service

Launch the service using `uvicorn`:
```bash
uvicorn upload:app --host 0.0.0.0 --port 8001
```

---

## 5. API Endpoints Deep Dive

Below is a detailed reference for each of the service's primary endpoints.

### `/render-and-upload/code`
*   **Method**: `POST`
*   **Description**: Renders source code into a PNG image and uploads it.
*   **Request Body**: `CodeRenderRequest`
    *   `code` (str): The source code to render.
    *   `language` (str): The programming language (e.g., "python", "javascript").
    *   `style` (str, optional): The Pygments style for syntax highlighting. Defaults to "default".
    *   `file_name` (str): The desired base name for the output file.
*   **Response**: `UploadResponse`
    *   `success` (bool): `true` if the upload was successful, `false` otherwise.
    *   `uploaded_url` (str): The public URL of the uploaded image.
    *   `message` (str): A message describing the result.

### `/render-and-upload/mermaid`
*   **Method**: `POST`
*   **Description**: Renders a Mermaid.js diagram into a PNG image and uploads it.
*   **Request Body**: `MermaidRenderRequest`
    *   `mermaid_code` (str): The Mermaid diagram syntax.
    *   `file_name` (str): The desired base name for the output file.
*   **Response**: `UploadResponse`
    *   `success` (bool): `true` if the upload was successful, `false` otherwise.
    *   `uploaded_url` (str): The public URL of the uploaded image.
    *   `message` (str): A message describing the result.

### `/upload/image`
*   **Method**: `POST`
*   **Description**: Uploads an image from a Base64 encoded string.
*   **Request Body**: `ImageUploadRequest`
    *   `file_base64` (str): The Base64 encoded image data.
    *   `file_name` (str): The desired base name for the output file.
    *   `content_type` (str): The MIME type of the image (e.g., "image/png").
*   **Response**: `UploadResponse`
    *   `success` (bool): `true` if the upload was successful, `false` otherwise.
    *   `uploaded_url` (str): The public URL of the uploaded image.
    *   `message` (str): A message describing the result.

### `/upload/image/file`
*   **Method**: `POST`
*   **Description**: Uploads an image file directly.
*   **Request Body**: `multipart/form-data`
    *   `file` (file): The image file to upload.
*   **Response**: `UploadResponse`
    *   `success` (bool): `true` if the upload was successful, `false` otherwise.
    *   `uploaded_url` (str): The public URL of the uploaded image.
    *   `message` (str): A message describing the result.

### `/upload/audio`
*   **Method**: `POST`
*   **Description**: Uploads an audio file directly.
*   **Request Body**: `multipart/form-data`
    *   `file` (file): The audio file to upload.
*   **Response**: `UploadResponse`
    *   `success` (bool): `true` if the upload was successful, `false` otherwise.
    *   `uploaded_url` (str): The public URL of the uploaded audio file.
    *   `message` (str): A message describing the result. 